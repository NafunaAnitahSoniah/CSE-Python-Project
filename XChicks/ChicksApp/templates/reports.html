{% extends 'base_manager.html' %}
{% block title %}Reports | Young4ChickS{% endblock %}

{% block extra_head %}
    <!-- Bootstrap 5 (scoped to this page) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/v/bs5/dt-2.1.8/datatables.min.css" rel="stylesheet"/>
    <style>
        .kpi-card .metric{font-size:1.8rem;font-weight:700}
        .badge-status{padding:.35rem .6rem;border-radius: .5rem}
        .badge-pending{background:#fff3cd;color:#856404}
        .badge-approved{background:#d1e7dd;color:#0f5132}
        .badge-rejected{background:#f8d7da;color:#842029}
        .badge-low{background:#fde2e1;color:#b02a37}
        .spinner-overlay{position:fixed;inset:0;background:rgba(255,255,255,.7);display:none;align-items:center;justify-content:center;z-index:1055}
    </style>
{% endblock %}

{% block content %}
<header class="page-header d-flex align-items-center justify-content-between">
    <h1 class="mb-0"><i class="fas fa-chart-line me-2"></i>Reports</h1>
    <div>
        <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="window.print()"><i class="fa-solid fa-print me-1"></i>Print</button>
        <a class="btn btn-outline-danger btn-sm me-2" href="{% url 'reports_export' %}?dataset=general&format=pdf&{{ request.GET.urlencode }}"><i class="fa-solid fa-file-pdf me-1"></i>General PDF</a>
        <a class="btn btn-outline-success btn-sm me-2" href="{% url 'reports_export' %}?dataset=general&format=xlsx&{{ request.GET.urlencode }}"><i class="fa-solid fa-file-excel me-1"></i>General Excel</a>
        <a class="btn btn-outline-secondary btn-sm" href="/export/sales/"><i class="fa-solid fa-file-lines me-1"></i>Legacy TXT Exports</a>
    </div>
    </header>

<!-- Filters -->
<div class="card mt-3">
    <div class="card-body">
        <form class="row g-3 align-items-end" method="get">
            <div class="col-md-3">
                <label class="form-label">Start date</label>
                <input type="date" name="start" value="{{ filters.start }}" class="form-control"/>
            </div>
            <div class="col-md-3">
                <label class="form-label">End date</label>
                <input type="date" name="end" value="{{ filters.end }}" class="form-control"/>
            </div>
            <div class="col-md-2">
                <label class="form-label">Chick type</label>
                <select name="chick_type" class="form-select">
                    <option value="">All</option>
                                {% for v,l in chick_type_choices %}
                                    <option value="{{ v }}" {% if filters.chick_type == v %}selected{% endif %}>{{ l }}</option>
                                {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Chick breed</label>
                <select name="chick_breed" class="form-select">
                    <option value="">All</option>
                                {% for v,l in chick_breed_choices %}
                                    <option value="{{ v }}" {% if filters.chick_breed == v %}selected{% endif %}>{{ l }}</option>
                                {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Feed type</label>
                <select name="feed_type" class="form-select">
                    <option value="">All</option>
                                {% for ft in feed_types %}
                                    <option value="{{ ft }}" {% if filters.feed_type == ft %}selected{% endif %}>{{ ft }}</option>
                                {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="">All</option>
                      <option value="pending" {% if filters.status == 'pending' %}selected{% endif %}>Pending</option>
                      <option value="approved" {% if filters.status == 'approved' %}selected{% endif %}>Approved</option>
                      <option value="rejected" {% if filters.status == 'rejected' %}selected{% endif %}>Rejected</option>
                      <option value="completed" {% if filters.status == 'completed' %}selected{% endif %}>Completed</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Sales agent</label>
                <select name="agent" class="form-select">
                    <option value="">All</option>
                    {% for a in agents %}
                        <option value="{{ a.id }}" {% if filters.agent|default:''|stringformat:'s' == a.id|stringformat:'s' %}selected{% endif %}>{{ a.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Farmer</label>
                <select name="farmer" class="form-select">
                    <option value="">All</option>
                    {% for f in farmers_all %}
                        <option value="{{ f.id }}" {% if filters.farmer|default:''|stringformat:'s' == f.id|stringformat:'s' %}selected{% endif %}>{{ f.farmer_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" name="q" value="{{ filters.q }}" class="form-control" placeholder="agent, farmer, request id..."/>
            </div>
            <div class="col-md-12 d-flex gap-2">
                <button class="btn btn-primary"><i class="fas fa-filter me-1"></i>Apply filters</button>
                <a href="{% url 'Reports' %}" class="btn btn-outline-secondary">Reset</a>
            </div>
        </form>
    </div>
    </div>

<!-- Inventory Reports -->
<div class="card mt-3">
    <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0"><i class="fa-solid fa-warehouse me-2"></i>Inventory</h5>
        <div class="btn-group btn-group-sm">
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=chick_stock&format=csv&{{ request.GET.urlencode }}">Chick CSV</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=chick_stock&format=xlsx&{{ request.GET.urlencode }}">Chick Excel</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=chick_stock&format=pdf&{{ request.GET.urlencode }}">Chick PDF</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=feed_stock&format=csv&{{ request.GET.urlencode }}">Feed CSV</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=feed_stock&format=xlsx&{{ request.GET.urlencode }}">Feed Excel</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=feed_stock&format=pdf&{{ request.GET.urlencode }}">Feed PDF</a>
        </div>
    </div>
    <div class="card-body">
    <h6 class="fw-bold mb-2">Chick Stock</h6>
    <div class="table-responsive mb-3">
            <table id="tblChickStock" class="table table-striped table-sm align-middle">
                <thead><tr>
                    <th>Batch</th><th>Type</th><th>Breed</th><th>Age</th><th>Price</th><th>Qty</th><th>Status</th>
                </tr></thead>
                <tbody>
                {% for s in chick_stock %}
                    <tr>
                        <td>{{ s.batch_name }}</td>
                        <td>{{ s.chick_type }}</td>
                        <td>{{ s.chick_breed }}</td>
                        <td>{{ s.chick_age }}</td>
                        <td>{{ s.chick_price }}</td>
                        <td>{{ s.stock_quantity }}</td>
                        <td>
                            {% if s.stock_quantity < 100 %}
                                <span class="badge-status badge-low"><i class="fa-solid fa-triangle-exclamation me-1"></i>Low</span>
                            {% else %}
                                <span class="badge-status badge-approved"><i class="fa-solid fa-check me-1"></i>OK</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot><tr><th colspan="5" class="text-end">Total</th><th>{{ chick_stock_total }}</th><th></th></tr></tfoot>
            </table>
        </div>
    <h6 class="fw-bold mt-4 mb-2">Feed Stock</h6>
    <div class="table-responsive">
            <table id="tblFeedStock" class="table table-striped table-sm align-middle">
                <thead><tr>
                    <th>Stock</th><th>Feed</th><th>Type</th><th>Brand</th><th>Qty</th><th>Unit Price</th>
                </tr></thead>
                <tbody>
                {% for s in feed_stock %}
                    <tr>
                        <td>{{ s.stock_name }}</td>
                        <td>{{ s.feed_name }}</td>
                        <td>{{ s.feed_type }}</td>
                        <td>{{ s.feed_brand }}</td>
                        <td>{{ s.feed_quantity }}</td>
                        <td>{{ s.selling_price }}</td>
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot><tr><th colspan="4" class="text-end">Total</th><th>{{ feed_stock_total }}</th><th></th></tr></tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Request Fulfillment -->
<div class="card mt-3">
    <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0"><i class="fa-solid fa-list-check me-2"></i>Request Fulfillment</h5>
        <div class="btn-group btn-group-sm">
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=chick_requests&format=csv&{{ request.GET.urlencode }}">Chick CSV</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=chick_requests&format=xlsx&{{ request.GET.urlencode }}">Chick Excel</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=chick_requests&format=pdf&{{ request.GET.urlencode }}">Chick PDF</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=feed_allocations&format=csv&{{ request.GET.urlencode }}">Feed CSV</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=feed_allocations&format=xlsx&{{ request.GET.urlencode }}">Feed Excel</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=feed_allocations&format=pdf&{{ request.GET.urlencode }}">Feed PDF</a>
        </div>
    </div>
    <div class="card-body">
        <div class="row g-3 mb-2">
            <div class="col">
                <div class="alert alert-light border d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Chick Requests:</strong>
                        <span class="badge-status badge-pending ms-2">Pending {{ stats.cr_pending }}</span>
                        <span class="badge-status badge-approved ms-2">Approved {{ stats.cr_approved }}</span>
                        <span class="badge-status badge-rejected ms-2">Rejected {{ stats.cr_rejected }}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="table-responsive mb-3">
                    <table id="tblChickReq" class="table table-hover table-sm align-middle">
                        <thead><tr>
                            <th>Req ID</th><th>Farmer</th><th>Type</th><th>Breed</th><th>Qty</th><th>Status</th><th>Date</th><th>Action</th>
                        </tr></thead>
                        <tfoot><tr>
                            <th>Req ID</th><th>Farmer</th><th>Type</th><th>Breed</th><th>Qty</th><th>Status</th><th>Date</th><th></th>
                        </tr></tfoot>
                <tbody>
                {% for r in chick_requests %}
                    <tr>
                        <td>{{ r.chick_request_id }}</td>
                        <td>{{ r.farmer.farmer_name }}</td>
                        <td>{{ r.chick_type }}</td>
                        <td>{{ r.chick_breed }}</td>
                        <td>{{ r.quantity }}</td>
                        <td>
                            {% if r.status == 'pending' %}<span class="badge-status badge-pending">Pending</span>
                            {% elif r.status == 'approved' %}<span class="badge-status badge-approved">Approved</span>
                            {% elif r.status == 'rejected' %}<span class="badge-status badge-rejected">Rejected</span>
                            {% else %}<span class="badge-status badge-approved">Completed</span>{% endif %}
                        </td>
                        <td>{{ r.request_date|date:'Y-m-d H:i' }}</td>
                                <td><a class="btn btn-sm btn-outline-secondary" href="/chickrequests/" title="View"><i class="fa-regular fa-eye"></i></a></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Feed Requests Summary (separate, directly above feed table) -->
        <div class="row g-3 mb-2 mt-4">
            <div class="col">
                <div class="alert alert-light border d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Feed Requests:</strong>
                        <span class="badge-status badge-pending ms-2">Pending {{ stats.fa_pending }}</span>
                        <span class="badge-status badge-approved ms-2">Approved {{ stats.fa_approved }}</span>
                        <span class="badge-status badge-rejected ms-2">Rejected {{ stats.fa_rejected }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
                    <table id="tblFeedAlloc" class="table table-hover table-sm align-middle">
                        <thead><tr>
                            <th>Feed ID</th><th>Req ID</th><th>Feed</th><th>Brand</th><th>Bags</th><th>Status</th><th>Payment</th><th>Action</th>
                        </tr></thead>
                        <tfoot><tr>
                            <th>Feed ID</th><th>Req ID</th><th>Feed</th><th>Brand</th><th>Bags</th><th>Status</th><th>Payment</th><th></th>
                        </tr></tfoot>
                <tbody>
                {% for a in feed_allocations %}
                    <tr>
                        <td>{{ a.feed_request_id }}</td>
                        <td>{{ a.chick_request.chick_request_id }}</td>
                        <td>{{ a.feed_name }}</td>
                        <td>{{ a.feed_brand }}</td>
                        <td>{{ a.bags_allocated }}</td>
                        <td>
                            {% if a.status == 'pending' %}<span class="badge-status badge-pending">Pending</span>
                            {% elif a.status == 'approved' %}<span class="badge-status badge-approved">Approved</span>
                            {% elif a.status == 'rejected' %}<span class="badge-status badge-rejected">Rejected</span>
                            {% else %}<span class="badge-status badge-approved">Completed</span>{% endif %}
                        </td>
                        <td>{{ a.payment_status|title }}</td>
                                <td><a class="btn btn-sm btn-outline-secondary" href="/feedrequests/" title="View"><i class="fa-regular fa-eye"></i></a></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Farmer Registration / Activity -->
<div class="card mt-3">
    <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0"><i class="fa-solid fa-users me-2"></i>Farmers</h5>
        <div class="btn-group btn-group-sm">
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=farmers&format=csv&{{ request.GET.urlencode }}">CSV</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=farmers&format=xlsx&{{ request.GET.urlencode }}">Excel</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=farmers&format=pdf&{{ request.GET.urlencode }}">PDF</a>
        </div>
    </div>
    <div class="card-body table-responsive">
        <table id="tblFarmers" class="table table-striped table-sm align-middle">
            <thead><tr>
                <th>Farmer ID</th><th>Name</th><th>Gender</th><th>Age</th><th>Phone</th><th>Location</th><th>Registered</th>
            </tr></thead>
            <tbody>
            {% for f in farmers %}
                <tr>
                    <td>{{ f.farmer_id }}</td>
                    <td>{{ f.farmer_name }}</td>
                    <td>{{ f.gender }}</td>
                    <td>{{ f.age }}</td>
                    <td>{{ f.phone_number }}</td>
                    <td>{{ f.location }}</td>
                    <td>{{ f.registration_date|date:'Y-m-d H:i' }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Sales Agent Performance -->
<div class="card mt-3">
    <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0"><i class="fa-solid fa-user-tie me-2"></i>Sales Agent Performance</h5>
        <div class="btn-group btn-group-sm">
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=agent_performance&format=csv&{{ request.GET.urlencode }}">CSV</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=agent_performance&format=xlsx&{{ request.GET.urlencode }}">Excel</a>
            <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=agent_performance&format=pdf&{{ request.GET.urlencode }}">PDF</a>
        </div>
    </div>

        <!-- Weekly Activity Summary -->
        <div class="card mt-3">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="mb-0"><i class="fa-solid fa-calendar-week me-2"></i>Weekly Activity</h5>
                <div class="btn-group btn-group-sm">
                    <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=activity_weekly&format=csv&{{ request.GET.urlencode }}">CSV</a>
                    <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=activity_weekly&format=xlsx&{{ request.GET.urlencode }}">Excel</a>
                    <a class="btn btn-outline-secondary" href="{% url 'reports_export' %}?dataset=activity_weekly&format=pdf&{{ request.GET.urlencode }}">PDF</a>
                </div>
            </div>
            <div class="card-body table-responsive">
                <table id="tblWeekly" class="table table-striped table-sm align-middle">
                    <thead><tr>
                        <th>Week</th><th>Chick Requests</th><th>Feed Allocations</th><th>Total</th>
                    </tr></thead>
                    <tbody>
                    {% for w in weekly_summary %}
                        <tr>
                            <td>{{ w.label }}</td>
                            <td>{{ w.chicks }}</td>
                            <td>{{ w.feeds }}</td>
                            <td>{{ w.total }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    <div class="card-body table-responsive">
        <table id="tblAgents" class="table table-striped table-sm align-middle">
            <thead><tr>
                <th>Agent</th><th>Requests</th><th>Approved</th><th>Rejected</th><th>Delivered</th>
            </tr></thead>
            <tbody>
            {% for row in agent_perf %}
                <tr>
                    <td>{{ row.agent }}</td>
                    <td>{{ row.total }}</td>
                    <td>{{ row.approved }}</td>
                    <td>{{ row.rejected }}</td>
                    <td>{{ row.delivered }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="spinner-overlay" id="spinner">
    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/v/bs5/dt-2.1.8/datatables.min.js"></script>
            <script>
        // Show spinner on form submit and export clicks
        (function(){
            const spinner=document.getElementById('spinner');
            document.querySelectorAll('form, a[href*="/reports/export"]').forEach(el=>{
                el.addEventListener('submit',()=>{spinner.style.display='flex'});
                el.addEventListener('click', (e)=>{
                    if(e.currentTarget.tagName==='A') spinner.style.display='flex'
                });
            });
        })();

        // DataTables init
            const simpleTables=['#tblChickStock','#tblFeedStock','#tblFarmers','#tblAgents','#tblWeekly'];
            simpleTables.forEach(sel=>{ const el=document.querySelector(sel); if(el){ new DataTable(el,{pageLength:10,order:[]}); }});

            function initColumnFilter(tableSelector){
                const el=document.querySelector(tableSelector);
                if(!el) return;
                // Add inputs to footer
                el.querySelectorAll('tfoot th').forEach((th,i)=>{
                    if(th.textContent){ th.innerHTML = '<input class="form-control form-control-sm" placeholder="Filter '+th.textContent+'" />'; }
                });
                const dt = new DataTable(el,{pageLength:10,order:[]});
                dt.on('init',()=>{
                    el.querySelectorAll('tfoot input').forEach((inp, idx)=>{
                        inp.addEventListener('keyup',()=>{ dt.columns().eq(idx).search(inp.value).draw(); });
                    });
                });
            }
            initColumnFilter('#tblChickReq');
            initColumnFilter('#tblFeedAlloc');

    </script>
{% endblock %}