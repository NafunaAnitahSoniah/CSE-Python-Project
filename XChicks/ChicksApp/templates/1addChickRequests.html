{% extends 'base_agent.html' %}
{% block title %}Add Chick Request | Young4ChickS{% endblock %}
{% block content %}
<header class="page-header">
    <h1>Add New Request</h1>
    <div class="subtitle">Create a chick request for a farmer</div>
</header>
<section class="card fade-in">
    <h4><i class="fas fa-plus"></i> Chick Request Form</h4>
    <form method="post" class="form-grid">
        {% csrf_token %}
        <div class="form-group">
            <label for="farmer">Farmer:</label>
            <select class="form-control" name="farmer" id="farmer" required>
                <option value="">Select Farmer</option>
                {% for customer in farmers %}
                <option value="{{ customer.id }}">{{ customer.farmer_name }} (ID: {{ customer.farmer_id }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="farmer_type">Farmer Type:</label>
            <select class="form-control" name="farmer_type" id="farmer_type" required>
                <option value="">Select Type</option>
                <option value="starter">Starter</option>
                <option value="returning">Returning</option>
            </select>
        </div>
        <div class="form-group">
            <label for="feed_name">Select Approved Feed (optional):</label>
            <select class="form-control" name="feed_name" id="feed_name">
                <option value="">None</option>
                {% for fa in approved_feeds %}
                <option value="{{ fa.feed_name }}">{{ fa.feed_name }} ({{ fa.feed_type }} - {{ fa.feed_brand }})</option>
                {% endfor %}
            </select>
            <small class="form-help">Only feeds from your approved feed allocations are listed.</small>
        </div>
        <div class="form-group">
            <label for="chick_type">Chick Type:</label>
            <select class="form-control" name="chick_type" id="chick_type" required>
                <option value="">Select Type</option>
                <option value="layer">Layer</option>
                <option value="broiler">Broiler</option>
            </select>
        </div>
        <div class="form-group">
            <label for="chick_breed">Chick Breed (shows available stock):</label>
            <select class="form-control" name="chick_breed" id="chick_breed" required>
                <option value="">Select Breed</option>
            </select>
            <small id="breedHint" class="form-help"></small>
        </div>
        <div class="form-group">
            <label for="quantity">Quantity:</label>
            <input class="form-control" type="number" name="quantity" id="quantity" min="1" required>
        </div>
    {# Chick Period removed as per requirements #}
        <div class="form-group">
            <label for="feed_taken">Feed Taken:</label>
            <select class="form-control" name="feed_taken" id="feed_taken" required>
                <option value="True">Yes</option>
                <option value="False">No</option>
            </select>
        </div>
        <div class="form-group">
            <label for="payment_terms">Payment Terms:</label>
            <select class="form-control" name="payment_terms" id="payment_terms" required>
                <option value="">Select Terms</option>
                <option value="mobile_money">Mobile Money</option>
                <option value="visa">Visa</option>
                <option value="cash">Cash</option>
            </select>
        </div>
        <div class="form-group">
            <label for="received_through">Received Through:</label>
            <select class="form-control" name="received_through" id="received_through" required>
                <option value="">Select Method</option>
                <option value="walk-in">Walk-in</option>
                <option value="phonecall">Phonecall</option>
            </select>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Submit Request</button>
            <a href="/addfeedrequest/" class="btn btn-secondary"><i class="fas fa-plus"></i> Add Feed Request</a>
            <a href="/salesagentdashboard/" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        </div>
    </form>
</section>
{% block extra_js %}
{{ stock_counts|json_script:"stockCounts" }}
<script>
document.addEventListener('DOMContentLoaded', function(){
    const typeSel = document.getElementById('chick_type');
    const breedSel = document.getElementById('chick_breed');
    const hint = document.getElementById('breedHint');
    // stock map from context
    const stock = JSON.parse(document.getElementById('stockCounts').textContent);
    function refreshBreeds(){
        const t = (typeSel.value||'').toLowerCase();
        breedSel.innerHTML = '<option value="">Select Breed</option>';
        if(!t || !stock[t]){ hint.textContent=''; return; }
        const localCount = stock[t].local||0;
        const exoticCount = stock[t].exotic||0;
        if(localCount>0){
            const opt = document.createElement('option');
            opt.value='local';
            opt.textContent=`Local — available: ${localCount}`;
            breedSel.appendChild(opt);
        }
        if(exoticCount>0){
            const opt = document.createElement('option');
            opt.value='exotic';
            opt.textContent=`Exotic — available: ${exoticCount}`;
            breedSel.appendChild(opt);
        }
        if(localCount===0 && exoticCount===0){
            hint.textContent = 'No stock available for the selected type.';
        } else {
            hint.textContent = '';
        }
    }
    typeSel && typeSel.addEventListener('change', refreshBreeds);
});
</script>
{% endblock %}
{% endblock %}